---
/** Layout for individual content pages (apps, products, companies, people, channels, etc) */

import { Image } from 'astro:assets';
import BaseLayout from './BaseLayout.astro';
import type { CollectionEntry } from 'astro:content';
import RightSidebar from '../components/RightSidebar.astro';
import Screenshots from '../components/Screenshots.astro';
import Engage from '@/components/Engage.astro';
import { resolveLogo } from '../utils/imageResolvers.ts';
import { formatCategoryName } from '../utils/textUtils.ts';
import googlePlayBadge from '../assets/images/badges/google-play-badge.png';
import appStoreBadge from '../assets/images/badges/app-store-badge.png';
import fdroidBadge from '../assets/images/badges/fdroid-badge.png';
import githubBadge from '../assets/images/badges/github-badge.png';

export interface Props {
    slug: string;
    title: string;
    description: string;
    image?: string;
    date: Date;
    tags?: string[];
    category: string;
    paid: boolean;
    offline: boolean;
    source: string;
    youtubeVideoLinks?: string[];
    externalLinks?: { label: string; url: string }[];
    storeLinks?: { label: string; url: string }[];
    repositoryLinks?: { label: string; url: string}[];
    screenshots?: Array<{ url: string }>;
    socials?: { label: string; url: string}[];
    authors?: Array<CollectionEntry<'persons'>>;
}

const {
    slug,
    title,
    description,
    image,
    date,
    tags,
    category,
    paid,
    offline,
    source,
    youtubeVideoLinks,
    externalLinks,
    storeLinks,
    repositoryLinks,
    screenshots,
    socials,
    authors = [],
} = Astro.props;
const resolvedImage = resolveLogo(slug, image);

// Get first author for display
const primaryAuthor = authors.length > 0 ? authors[0] : null;
const authorLink = primaryAuthor ? `/${primaryAuthor.collection}/${primaryAuthor.slug}` : null;
---

<BaseLayout
    title={title}
    description={description}
    image={image}
    article={true}
    publishedTime={date.toISOString()}
    tags={tags}
>
    <div class="flex flex-col lg:flex-row gap-0 relative justify-center items-center">
        <article
            class="max-w-6xl px-10 py-8 lg:h-[calc(100vh-4rem)] lg:overflow-y-auto scrollbar-hide"
        >
            <header class="mb-12 rounded-2xl ring ring-primary-300/80 dark:ring-primary-800">
                <div
                    class="grid grid-cols-1 gap-6 p-3 md:grid-cols-[96px_minmax(0,1fr)] xl:grid-cols-[96px_minmax(0,2fr)_minmax(0,2fr)_minmax(0,3fr)] xl:grid-rows-2 shadow-2xl shadow-primary-400/80 dark:shadow-2xl dark:shadow-primary-900/80"
                >
                    <!-- Column 1: Logo -->
                    {
                        resolvedImage && (
                            <div class="rounded-xl md:row-span-3 xl:row-span-2 flex items-start justify-start">
                                <div class="w-24 h-24 flex-shrink-0 rounded-lg overflow-hidden">
                                    <Image
                                        class="w-full h-full object-contain"
                                        src={resolvedImage}
                                        alt={title}
                                        loading="eager"
                                        format="webp"
                                        width={96}
                                        height={96}
                                    />
                                </div>
                            </div>
                        )
                    }

                    <!-- Column 2: Title and Author -->
                    <div
                        class="min-w-0 flex flex-col justify-center gap-1 md:col-start-2 xl:col-start-2 xl:row-span-2"
                    >
                        <h1
                            class="text-lg sm:text-xl lg:text-2xl font-bold tracking-tight leading-tight line-clamp-2 min-w-0"
                        >
                            {title}
                        </h1>
                        {
                            primaryAuthor && (
                                <div class="text-xs sm:text-sm text-gray-600 dark:text-gray-400 line-clamp-1 min-w-0">
                                    <span class="text-gray-500 dark:text-gray-500">by </span>
                                    <a
                                        href={authorLink}
                                        class="text-primary-600 dark:text-primary-400 hover:underline font-medium"
                                    >
                                        {primaryAuthor.data.name}
                                    </a>
                                </div>
                            )
                        }
                    </div>

                    <!-- Column 3: Badges -->
                    <div
                        class="min-w-0 flex items-center grid grid-cols-1 gap-4 content-center md:col-start-2 xl:col-start-3 xl:row-span-2"
                    >
                        <div class="w-full flex flex-wrap gap-2 content-start gap-4">
                            <span
                                class={`rounded-lg ring-1 text-black min-w-0 px-2 py-2 font-medium text-center text-xs text-balance line-clamp-2 ${
                                    source === 'open-source'
                                        ? 'bg-green-300 ring-green-300'
                                        : 'bg-red-400 ring-red-400'
                                }`}
                            >
                                {source === 'open-source' ? 'Open Source' : 'Closed Source'}
                            </span>
                            <span
                                class={`rounded-lg ring-1 text-black bg-green min-w-0 px-2 py-2 font-medium text-center leading-tight text-xs line-clamp-2 ${
                                    paid ? 'bg-red-400 ring-red-400' : 'bg-green-300 ring-green-300'
                                }`}
                            >
                                {paid ? 'Paid' : 'Free'}
                            </span>
                            <span
                                class="rounded-lg ring-1 ring-black dark:ring-white text-black dark:text-white min-w-0 px-2 py-2 font-medium text-center leading-tight text-xs"
                            >
                                {offline ? 'Works offline' : 'Needs internet'}
                            </span>
                            <span
                                class="rounded-lg ring-1 ring-black dark:ring-white text-black dark:text-white min-w-0 px-2 py-2 font-medium text-center text-xs text-balance line-clamp-2"
                            >
                                {formatCategoryName(category)}
                            </span>
                        </div>
                    </div>

                    <!-- Column 4: Tags -->
                    {
                        tags && tags.length > 0 && (
                            <div class="min-w-0 flex items-start md:col-start-2 xl:col-start-4 xl:row-span-2 pt-2 line-clamp-2">
                                <div class="w-full h-[60px] overflow-y-auto overflow-x-hidden flex flex-wrap gap-2 content-start scrollbar-hide">
                                    {tags.map((tag) => (
                                        <a
                                            href={`/tags/${tag}`}
                                            class="text-xs px-3 py-1 rounded-full bg-primary-600 dark:bg-primary-300 text-white dark:text-black hover:bg-primary-700 dark:hover:bg-primary-200 transition-colors whitespace-nowrap flex-shrink-0"
                                        >
                                            #{tag}
                                        </a>
                                    ))}
                                </div>
                            </div>
                        )
                    }
                </div>
            </header>

            <!-- Description -->
            <div class="mt-10 mb-6 px-4 sm:px-4 lg:px-0">
                <p
                    class="text-base sm:text-lg text-gray-700 dark:text-gray-300 leading-relaxed max-w-none"
                >
                    {description}
                </p>
            </div>

            <!-- Screenshots -->
            {screenshots && <Screenshots screenshots={screenshots} />}

            <!-- Store badges -->
            {
                storeLinks && storeLinks.length > 0 && (
                    <div class="mb-6 px-2 sm:px-2 lg:px-0">
                        <div class="flex flex-wrap gap-4 items-center justify-center">
                            {storeLinks.map((store) => {
                                const isPlayStore =
                                    store.label.toLowerCase().includes('play store') ||
                                    store.url.includes('play.google.com');
                                const isAppStore =
                                    store.label.toLowerCase().includes('app store') ||
                                    store.url.includes('apps.apple.com');
                                const isFdroidStore =
                                    store.label.toLowerCase().includes('fdroid') ||
                                    store.url.includes('f-droid.org');
                                const isGithubRelease =
                                    store.label.toLowerCase().includes('github') ||
                                    store.url.includes('github.com');

                                return (
                                    <a
                                        href={store.url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="inline-block hover:scale-105"
                                        aria-label={`Get it on ${store.label}`}
                                    >
                                        {isPlayStore ? (
                                            <Image
                                                src={googlePlayBadge}
                                                alt={`Get it on ${store.label}`}
                                                class="h-12 sm:h-14 md:h-16 w-auto"
                                                format="webp"
                                                widths={[124, 145, 165, 200]}
                                                sizes="(min-width:768px) 165px (min-width:640px) 145px, 124px"
                                                loading="lazy"
                                            />
                                        ) : isFdroidStore ? (
                                            <Image
                                                src={fdroidBadge}
                                                alt={`Get it on ${store.label}`}
                                                class="h-12 sm:h-14 md:h-16 w-auto"
                                                format="webp"
                                                widths={[124, 145, 165, 200]}
                                                sizes="(min-width:768px) 165px (min-width:640px) 145px, 124px"
                                                loading="lazy"
                                            />
                                        ) : isAppStore ? (
                                            <Image
                                                src={appStoreBadge}
                                                alt={`Get it on ${store.label}`}
                                                class="h-12 sm:h-10 md:h-12 w-auto"
                                                format="webp"
                                                widths={[124, 145, 165, 200]}
                                                sizes="(min-width:768px) 165px (min-width:640px) 145px, 124px"
                                                loading="lazy"
                                            />
                                        ) : isGithubRelease ? (
                                            <Image
                                                src={githubBadge}
                                                alt={`Get it on ${store.label}`}
                                                class="h-12 sm:h-14 md:h-16 w-auto"
                                                format="webp"
                                                widths={[124, 145, 165, 200]}
                                                sizes="(min-width:768px) 165px (min-width:640px) 145px, 124px"
                                                loading="lazy"
                                            />
                                        ) : (
                                            <div class="h-12 sm:h-10 md:h-11 px-6 flex items-center justify-center bg-gray-900 dark:bg-gray-100 rounded-lg text-white dark:text-gray-900 font-semibold text-sm sm:text-base whitespace-nowwrap hover:bg-gray-800 dark:hover:bg-gray-200 transition-colors">
                                                {store.label}
                                            </div>
                                        )}
                                    </a>
                                );
                            })}
                        </div>
                    </div>
                )
            }

            <!-- Engagement -->
            <Engage
                repositoryLinks={repositoryLinks}
                source={source}
                socials={socials}
            />

            <!-- Features -->
            <div class="prose prose-lg dark:prose-dark max-w-none">
                <slot />
            </div>

            <!-- Youtube Links -->

            <!-- Additional resources -->
            {
                (youtubeVideoLinks || externalLinks) && (
                    <footer class="mt-12 pt-8 border-t border-gray-200 dark:border-gray-800">
                        {youtubeVideoLinks && youtubeVideoLinks.length > 0 && (
                            <div class="mb-6">
                                <h3 class="text-xl font-semibold mb-3">Related Videos</h3>
                                <ul class="space-y-2">
                                    {youtubeVideoLinks.map((link) => (
                                        <li>
                                            <a
                                                href={link}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="text-primary-600 dark:text-primary-400 hover:underline"
                                            >
                                                {link}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {externalLinks && externalLinks.length > 0 && (
                            <div class="mb-6">
                                <h3 class="text-xl font-semibold mb-3">External Resources</h3>
                                <ul class="space-y-2">
                                    {externalLinks.map((link) => (
                                        <li>
                                            <a
                                                href={link.url}
                                                target="_blank"
                                                rel="noopener noreferrer"
                                                class="text-primary-600 dark:text-primary-400 hover:underline"
                                            >
                                                {link.label}
                                            </a>
                                        </li>
                                    ))}
                                </ul>
                            </div>
                        )}
                    </footer>
                )
            }
        </article>

        <RightSidebar>
            <slot name="right-sidebar" />
        </RightSidebar>
    </div>
</BaseLayout>
