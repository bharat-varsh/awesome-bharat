---
import { getCollection } from 'astro:content';
import type { GetStaticPaths } from 'astro';
import type { CollectionEntry } from 'astro:content';
import type { Author } from '@/content/config.ts';
import ContentLayout from '@/layouts/ContentLayout.astro';
import Engage from '@/components/Engage.astro';
import YouMightLike from '@components/YouMightLike.astro';
import { getRelatedContentSimple } from '@utils/relatedContent.js';
import Divider from '@/components/Divider.astro';

export const getStaticPaths = (async () => {
    const apps = (await getCollection('apps')) as Array<CollectionEntry<'apps'>>;
    const publishedApps = apps.filter((app) => !app.data.draft);

    return publishedApps.map((app) => ({
        params: { slug: app.slug },
        props: { app, allApps: publishedApps },
    }));
}) satisfies GetStaticPaths;

const { app, allApps } = Astro.props as {
    app: CollectionEntry<'apps'>;
    allApps: Array<CollectionEntry<'apps'>>;
};
const persons = (await getCollection('persons')) as Array<CollectionEntry<'persons'>>;
const resolvedAuthors = app.data.authors
    .map((author: Author) => persons.find((person) => person.slug === author.slug))
    .filter((author: Author): author is CollectionEntry<'persons'> => Boolean(author));

const { Content } = await app.render();

const relatedApps = getRelatedContentSimple(app, allApps, 'apps', 8);
const relatedAppsEnriched = relatedApps.map((app) => ({
    item: app,
    resolved: {
        author: app.data.authors[0]
            ? persons.find((p) => p.slug === app.data.authors[0].slug)
            : null,
    },
}));
---

<ContentLayout
    slug={app.slug}
    title={app.data.title}
    description={app.data.description}
    image={app.data.logo}
    date={app.data.date}
    tags={app.data.tags}
    category={app.data.category}
    paid={app.data.paid}
    offline={app.data.offline}
    source={app.data.source}
    youtubeVideoLinks={app.data.youtubeVideoLinks}
    externalLinks={app.data.externalLinks}
    storeLinks={app.data.storeLinks}
    screenshots={app.data.screenshots}
    authors={resolvedAuthors}
>
    <Content />

    <!-- Right sidebar content -->
    <div slot="right-sidebar">
        <Engage app={app} />

        <Divider />

        <YouMightLike
            items={relatedAppsEnriched}
            collectionName="apps"
            title="You might also like"
            maxItems={8}
        />
    </div>
</ContentLayout>
